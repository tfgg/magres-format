import math

import constants
import units

try:
  import numpy
except ImportError:
  numpy = None

def sorted_evals(mat):
  if numpy is None:
    raise Exception("Numpy module required to diagonalise EFG tensor")

  eval, evec = numpy.linalg.eig(mat)
  eval = sorted(eval, key=lambda x: abs(x))
  return (eval[2], (eval[0]-eval[1])/eval[2])

def efg_to_Cq(efg, s):
  # Magic constants to convert from millibarns to a.u. and then back to MHz
  if s in Q_iso:
    return sorted_evals(efg)[0] * (Q_common[s] * units.millibarn) / units.megahertz
  else:
    return None

def val_to_Cq(ev, s):
  if s in Q_iso:
    return ev * Q_common[s] * units.millibarn / units.megahertz
  else:
    return ev

def largest_eval(m):
  return sorted_evals(m)[0]

def K_to_J(K, s1, s2):
  # More magic constants. Should make a proper atomic unit conversion function
  return (K + K.H)/2.0 * gamma_common[s1] * gamma_common[s2] * 1.05457148e-15 / (2*math.pi)

def K_to_J_iso(K, s1, iso1, s2, iso2):
  return (K + K.H)/2.0 * gamma[(s1,iso1)] * gamma[(s2,iso2)] * 1.05457148e-15 / (2*math.pi)

# Nuclear gyromagnetic ratios, from constants.f90, source IUPAC Recommendations 2001, Robin K. Harris et al
gamma={('H', 1): 26.7522128e7,
       ('H', 2): 4.10662791e7,
       ('H', 3): 28.5349779e7,
       ('He', 3): -20.3801587e7,
       ('Li', 6): 3.9371709e7,
       ('Li', 7): 10.3977013e7,
       ('Be', 9): -3.759666e7,
       ('B', 10): 2.8746786e7,
       ('B', 11): 8.5847044e7,
       ('C', 13): 6.728284e7,
       ('N', 14): 1.9337792e7,
       ('N', 15): -2.71261804e7,
       ('O', 17): -3.62808e7,
       ('F', 19): 25.18148e7,
       ('Ne', 21): -2.11308e7,
       ('Na', 23): 7.0808493e7,
       ('Mg', 25): -1.63887e7, 
       ('Al', 27): 6.9762715e7,
       ('Si', 29): -5.3190e7,
       ('P', 31): 10.8394e7,
       ('S', 33): 2.055685e7,                  
       ('Cl', 35): 2.624198e7,
       ('Cl', 37): 2.184368e7,
       ('K', 39): 1.2500608e7,
       ('K', 40): -1.5542854e7,
       ('K', 41): 0.68606808e7,
       ('Ca', 43): -1.803069e7,           
       ('Sc', 45): 6.5087973e7,
       ('Ti', 47): -1.5105e7,
       ('Ti', 49): -1.51095e7,
       ('V', 50): 2.6706490e7,
       ('V', 51): 7.0455117e7,
       ('Cr', 53): -1.5152e7,
       ('Mn', 55): 6.6452546e7,
       ('Fe', 57): 0.8680624e7,
       ('Co', 59): 6.332e7,
       ('Ni', 61): -2.3948e7,
       ('Cu', 63): 7.1117890e7,
       ('Cu', 65): 7.60435e7,
       ('Zn', 67): 1.676688e7,
       ('Ga', 69): 6.438855e7,
       ('Ga', 71): 8.181171e7,
       ('Ge', 73): -0.9360303e7,                  
       ('As', 75): 4.596163e7,
       ('Se', 77): 5.1253857e7,
       ('Br', 79): 6.725616e7,
       ('Br', 81): 7.249776e7,
       ('Kr', 83): -1.03310e7,              
       ('Rb', 85): 2.5927050e7,
       ('Rb', 87): 8.786400e7,
       ('Sr', 87): -1.1639376e7,
       ('Y', 89): -1.3162791e7,
       ('Zr', 91): -2.49743e7, 
       ('Nb', 93): 6.5674e7,
       ('Mo', 95): 1.751e7,
       ('Mo', 97): -1.788e7,
       ('Tc', 99): 6.046e7,
       ('Ru', 99): -1.229e7,
       ('Rh', 103): -0.8468e7,
       ('Pd', 105): -1.23e7,
       ('Ag', 107): -1.0889181e7,
       ('Ag', 109): -1.2518634e7,
       ('Cd', 111): -5.6983131e7,
       ('Cd', 113): -5.9609155e7,
       ('In', 113): 5.8845e7,
       ('In', 115): 5.8972e7,
       ('Sn', 115): -8.8013e7,
       ('Sn', 117): -9.58879e7,
       ('Sn', 119): -10.0317e7,
       ('Sb', 121): 6.4435e7,
       ('Sb', 123): 3.4892e7,
       ('Te', 123): -7.059098e7,
       ('Te', 125): -8.5108404e7,                      
       ('I', 127): 5.389573e7,
       ('Xe', 131): 2.209076e7,
       ('Cs', 133): 3.5332539e7,
       ('Ba', 135): 2.67550e7,
       ('Ba', 137): 2.99295e7,
       ('La', 138): 3.557239e7,
       ('La', 139): 3.8083318e7,
       ('Pr', 141): 8.1907e7,
       ('Nd', 143): -1.457e7,
       ('Nd', 145): -0.898e7,
       ('Sm', 147): -1.115e7,
       ('Sm', 149): -0.9192e7,
       ('Eu', 151): 6.6510e7,
       ('Eu', 153): 2.9369e7,
       ('Gd', 155): -0.82132e7,
       ('Gd', 157): -1.0769e7,
       ('Tb', 159): 6.431e7,
       ('Dy', 161): -0.9201e7,
       ('Dy', 163): 1.289e7,
       ('Ho', 165): 5.710e7,
       ('Er', 167): -0.77157e7,
       ('Tm', 169): -2.218e7,
       ('Yb', 171): 4.7288e7,
       ('Yb', 173): -1.3025e7,
       ('Lu', 175): 3.0552e7,
       ('Lu', 176): 2.1684e7,
       ('Hf', 177): 1.086e7,
       ('Hf', 179): -0.6821,
       ('Ta', 181): 3.2438e7,
       ('W', 183): 1.1282403e7,
       ('Re', 185): 6.1057e7,
       ('Re', 187): 6.1682e7,
       ('Os', 189): 2.10713e7,
       ('Ir', 191): 0.4812e7,
       ('Ir', 193): 0.5227e7,
       ('Pt', 195): 5.8385e7,
       ('Au', 197): 0.473060e7,
       ('Hg', 201): -1.788769e7,
       ('Hg', 199): 4.8457916e7,
       ('Tl', 203): 15.5393338e7,
       ('Tl', 205): 15.6921808e7,
       ('Pb', 207): 5.58046e7,
       ('Bi', 209): 4.3750e7,
       ('U', 235): -0.52e7,}

# Isotope of most common spin active nucleus for each species
gamma_iso = {'H': 1,
             'He': 3,
             'Li': 7,
             'Be': 9,
             'B': 11,
             'C': 13,
             'N': 14, #
             'O': 17,
             'F': 19,
             'Ne': 21,
             'Na': 23,
             'Mg': 25,
             'Al': 27,
             'Si': 29,
             'P': 31,
             'S': 33,
             'Cl': 35,
             'K': 39,
             'Ca': 43,
             'Sc': 45,
             'Ti': 49, # Maybe exclude arbitrary ones from this? 47Ti and 49Ti both fairly equal, UI can prompt
             'V': 51,
             'Cr': 53,
             'Mn': 55,
             'Fe': 57,
             'Co': 59,
             'Ni': 61,
             'Cu': 65, #
             'Zn': 67,
             'Ga': 71,
             'Ge': 73,
             'As': 75,
             'Se': 77,
             'Br': 81,
             'Kr': 83,
             'Rb': 87,
             'Sr': 87,
             'Y': 89,
             'Zr': 91,
             'Nb': 93,
             'Mo': 95,
             'Tc': 99,
             'Ru': 99, # Also 101
             'Rh': 103,
             'Pd': 105,
             'Ag': 109, #
             'Cd': 113,
             'In': 115,
             'Sb': 121,
             'I': 127,
             'Sn': 119,
             'Te': 125,
             'Xe': 129, # Also 131
             'Cs': 133,
             'Ba': 137,
             'La': 139,
             'Hf': 179, # Also 177
             'Ta': 181,
             'W': 183,
             'Re': 187,
             'Os': 187, # Also 189 ?? no 187Os in gamma list
             'Ir': 193,
             'Pt': 195,
             'Au': 197,
             'Hg': 199, # Also 201
             'Tl': 205,
             'Pb': 207,
             'Bi': 209,}

gamma_common = {}
for s, i in gamma_iso.items():
  if (s,i) in gamma:
   gamma_common[s] = gamma[(s,i)]

# Quadrupole moments of all nuclear isotopes, from P. Pyykko, J. Mol. Phys, 2008 106 1965-1974
# Units of mb, Q/10/fm^2
Q = {('H', 2): 2.860,
     ('Li', 6): -0.808,
     ('Li', 7): -40.1,
     ('Be', 9): 52.88,
     ('B', 10): 84.59,
     ('B', 11): 40.59,
     ('C', 11): 33.27,
     ('N', 14): 20.44,
     ('O', 17): -25.58,
     ('F', 19): -94.2,
     ('Ne', 21): 101.55,
     ('Na', 23): 104,
     ('Mg', 25): 199.4,
     ('Al', 27): 146.6,
     ('S', 33): -67.8,
     ('S', 35): 47.1,
     ('Cl', 35): -81.65,
     ('Cl', 37): -64.35,
     ('K', 39): 58.5,
     ('K', 40): -73,
     ('K', 41): 71.1,
     ('Ca', 41): -66.5,
     ('Ca', 43): -40.8,
     ('Sc', 45): -220,
     ('Ti', 47): 302,
     ('Ti', 49): 247,
     ('V', 50): 210,
     ('V', 51): -52,
     ('Cr', 53): -150,
     ('Mn', 55): 330,
     ('Fe', 57): 160,
     ('Co', 59): 420,
     ('Ni', 61): 162,
     ('Cu', 63): -220,
     ('Cu', 65): -204,
     ('Zn', 67): 150,
     ('Ga', 69): 171,
     ('Ga', 71): 107,
     ('Ge', 73): -196,
     ('As', 75): 314,
     ('Se', 77): 760,
     ('Br', 79): 313,
     ('Br', 81): 262,
     ('Kr', 83): 259,
     ('Rb', 85): 276,
     ('Rb', 87): 133.5,
     ('Sr', 87): 305,
     ('Y', 90): -125,
     ('Zr', 91): -176,
     ('Nb', 93): -320,
     ('Mo', 95): -22,
     ('Mo', 97): 255,
     ('Tc', 99): -129,
     ('Ru', 99): 79,
     ('Ru', 101): 457,
     ('Pd', 105): 660,
     ('In', 113): 759,
     ('In', 115): 770,
     ('Sn', 119): -132,
     ('Sb', 121): -543,
     ('Sb', 123): -692,
     ('I', 127): -696,
     ('Xe', 131): -114,
     ('Cs', 133): -3.43,
     ('Ba', 135): 160,
     ('Ba', 137): 245,
     ('La', 138): 450,
     ('La', 139): 200,
     ('Pr', 141): -58.9,
     ('Nd', 143): -630,
     ('Nd', 145): -330,
     ('Pm', 147): 740,
     ('Sm', 147): -259,
     ('Sm', 149): 75,
     ('Eu', 151): 903,
     ('Eu', 153): 2412,
     ('Gd', 155): 1270,
     ('Gd', 157): 1350,
     ('Tb', 159): 1432,
     ('Dy', 161): 2507,
     ('Dy', 163): 2648,
     ('Ho', 165): 3580,
     ('Er', 167): 3565,
     ('Tm', 169): -1200, # Tm missing from Pyykko
     ('Yb', 173): 2800,
     ('Lu', 175): 3490,
     ('Lu', 176): 4970,
     ('Hf', 177): 3365,
     ('Hf', 179): 3793,
     ('Ta', 181): 3170,
     ('Re', 185): 2180,
     ('Re', 187): 2070,
     ('Os', 189): 856,
     ('Ir', 191): 816,
     ('Ir', 193): 751,
     ('Au', 197): 547,
     ('Hg', 201): 387,
     ('Pb', 209): -269,
     ('Bi', 209): -516,
     ('Rn', 209): 311,
     ('Fr', 223): 1170,
     ('Ra', 223): 1210, # Ra missing from Pyykko
     ('Ac', 227): 1700,
     ('Th', 229): 4300,
     ('Pa', 231): -1720,
     ('U', 233): 3663,
     ('U', 235): 4936,
     ('Np', 237): 3886,
     ('Pu', 241): 5600,
     ('Am', 243): 4210,
     ('Es', 253): 6700,
    }

# Isotope of most common quadrupolar nucleus, from castep constants.f90
Q_iso = {'H': 2,
         'Li': 7,
         'Be': 9,
         'B': 11,
         'C': 11,
         'N': 14,
         'O': 17,
         'Ne': 21,
         'Na': 23,
         'Mg': 25,
         'Al': 27,
         'S': 33,
         'Cl': 35,
         'K': 39,
         'Ca': 43,
         'Sc': 45,
         'Ti': 47,
         'V': 51,
         'Cr': 53,
         'Mn': 55,
         'Fe': 57,
         'Co': 59,
         'Ni': 61,
         'Cu': 63,
         'Zn': 67,
         'Ga': 71,
         'Ge': 73,
         'As': 75,
         'Br': 81,
         'Kr': 83,
         'Rb': 87,
         'Sr': 87,
         'Y': 90,
         'Zr': 91,
         'Nb': 93,
         'Mo': 95,
         'Tc': 99,
         'Ru': 99,
         'Pd': 105,
         'In': 115,
         'Sb': 121,
         'I': 127,
         'Xe': 131,
         'Cs': 133,
         'Ba': 137,
         'La': 139,
         'Pr': 141,
         'Nd': 143,
         'Pm': 147,
         'Sm': 149,
         'Eu': 153,
         'Gd': 157,
         'Tb': 159,
         'Dy': 163,
         'Ho': 165,
         'Er': 167,
         'Tm': 169,
         'Yb': 173,
         'Lu': 175,
         'Hf': 177,
         'Ta': 181,
         'Re': 187,
         'Os': 189,
         'Ir': 193,
         'Au': 197,
         'Hg': 201,
         'Pb': 209,
         'Bi': 209,
         'Rn': 209,
         'Fr': 223,
         'Ra': 223,
         'Ac': 227,
         'Th': 229,
         'Pa': 231,
         'U': 235,
         'Np': 237,
         'Pu': 241,
         'Am': 243,
         'Es': 253,}

Q_common = {}
for s, i in Q_iso.items():
  if (s,i) in gamma:
    Q_common[s] = Q[(s,i)]

